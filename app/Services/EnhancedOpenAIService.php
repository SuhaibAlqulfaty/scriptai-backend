<?php

namespace App\Services;

use OpenAI\Laravel\Facades\OpenAI;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Facades\Cache;

class EnhancedOpenAIService
{
    protected $client;
    protected $processingStartTime;

    public function __construct()
    {
        // OpenAI client is available through the facade
        $this->processingStartTime = microtime(true);
    }

    /**
     * Enhanced multi-stage script generation
     */
    public function generateIntelligentScript(string $topic, ?string $keyPoints, string $tone, string $language = 'ar', int $duration = 60): array
    {
        try {
            if (!$this->client) {
                return $this->getEnhancedMockResponse($topic, $keyPoints, $tone, $duration);
            }

            // Stage 1: Analyze topic and gather insights
            $insights = $this->analyzeTopicAndGatherInsights($topic, $tone);
            
            // Stage 2: Generate optimized hooks
            $hooks = $this->generateOptimizedHooks($insights, $tone, $topic);
            
            // Stage 3: Generate relevant statistics
            $statistics = $this->generateRelevantStatistics($topic);
            
            // Stage 4: Assemble optimized script
            $script = $this->assembleOptimizedScript($topic, $keyPoints, $insights, $hooks, $statistics, $tone, $duration);
            
            // Stage 5: Quality analysis
            $qualityAnalysis = $this->analyzeScriptQuality($script, $tone, $duration);
            
            return [
                'success' => true,
                'script' => $script,
                'word_count' => str_word_count($script),
                'estimated_duration' => $this->calculateDuration($script, $tone),
                'quality_analysis' => $qualityAnalysis,
                'insights_used' => $insights,
                'hooks_generated' => $hooks,
                'statistics_used' => $statistics,
                'generation_metadata' => [
                    'stages_completed' => 5,
                    'processing_time' => $this->getProcessingTime(),
                    'confidence_score' => $qualityAnalysis['confidence_score'] ?? 0.85,
                    'enhancement_level' => 'intelligent'
                ]
            ];

        } catch (\Exception $e) {
            Log::error('Enhanced OpenAI API Error: ' . $e->getMessage());
            return $this->getEnhancedMockResponse($topic, $keyPoints, $tone, $duration);
        }
    }

    /**
     * Stage 1: Analyze topic and gather insights
     */
    private function analyzeTopicAndGatherInsights(string $topic, string $tone): array
    {
        $cacheKey = "insights_" . md5($topic . $tone);
        
        return Cache::remember($cacheKey, 1800, function() use ($topic, $tone) {
            $analysisPrompt = "
ุฃูุช ุฎุจูุฑ ุชุญููู ุงููุญุชูู ูุงูุงุชุฌุงูุงุช. ูู ุจุชุญููู ุงูููุถูุน ุงูุชุงูู ูุฌูุน ุงููุนูููุงุช ุงููุทููุจุฉ:

ุงูููุถูุน: {$topic}
ุงููุจุฑุฉ ุงููุทููุจุฉ: {$tone}

ุงููุทููุจ ููู ุชุญููู ุดุงูู ูุชุถูู:

1. ุฅุญุตุงุฆูุงุช ูุคุซุฑุฉ (3-5 ุฅุญุตุงุฆูุงุช):
   - ุงุจุญุซ ูู ูุนุฑูุชู ุนู ุฃุญุฏุซ ุงูุฅุญุตุงุฆูุงุช ุงููุชุนููุฉ ุจูุฐุง ุงูููุถูุน
   - ุฑูุฒ ุนูู ุงูุฃุฑูุงู ุงูุตุงุฏูุฉ ุฃู ุงูููุงุฌุฆุฉ ูู 2022-2024
   - ุชุฃูุฏ ูู ุฏูุฉ ุงููุนูููุงุช ูุญุฏุงุซุชูุง
   - ุงุฐูุฑ ูุตุฏุฑ ุชูุฑูุจู ููุฅุญุตุงุฆูุฉ

2. ููุงุท ุฃูู ุงูุฌูููุฑ (3-4 ููุงุท):
   - ูุง ูู ุฃูุจุฑ ุงูุชุญุฏูุงุช ุงูุชู ููุงุฌููุง ุงููุงุณ ูู ูุฐุง ุงููุฌุงูุ
   - ูุง ูู ุงูุฃุฎุทุงุก ุงูุดุงุฆุนุฉ ุงูุชู ูุฑุชูุจูููุงุ
   - ูุง ูู ุงููุฎุงูู ูุงูููู ุงูุฑุฆูุณูุฉุ
   - ูุง ูู ุงูุนูุงุฆู ุงูุชู ุชููุนูู ูู ุงููุฌุงุญุ

3. ุญููู ูููุงุฆุฏ (3-4 ุญููู):
   - ุญููู ุนูููุฉ ููุงุจูุฉ ููุชุทุจูู ููุฑุงู
   - ููุงุฆุฏ ูุงุถุญุฉ ููุญุฏุฏุฉ ุจุฃุฑูุงู
   - ูุชุงุฆุฌ ูููู ููุงุณูุง ูุชุญููููุง
   - ุฎุทูุงุช ุจุณูุทุฉ ูููู ุงุชุจุงุนูุง

4. ุฃูุซูุฉ ูุงุฌุญุฉ:
   - ูุตุต ูุฌุงุญ ุญููููุฉ ุฃู ูุนุฑููุฉ ูู ูุฐุง ุงููุฌุงู
   - ุฃุฑูุงู ููุชุงุฆุฌ ูุญุฏุฏุฉ ูููููุณุฉ
   - ุฃุดุฎุงุต ุฃู ุดุฑูุงุช ูุดููุฑุฉ ููุฑุงุฌุน
   - ุชูุงุตูู ุนู ููููุฉ ุชุญููู ุงููุฌุงุญ

5. ูููุงุช ููุชุงุญูุฉ ูููุฉ:
   - ูููุงุช ุชุซูุฑ ุงููุดุงุนุฑ ูุงูุญูุงุณ
   - ูุตุทูุญุงุช ุชูููุฉ ูููุฉ ูู ุงููุฌุงู
   - ุนุจุงุฑุงุช ุฑุงุฆุฌุฉ ููุคุซุฑุฉ
   - ูููุงุช ุชุฎูู ุฅูุญุงุญุงู ููุถููุงู

6. ุงุชุฌุงูุงุช ุญุงููุฉ (2024):
   - ูุง ูู ุงูุฑุงุฆุฌ ุงูุขู ูู ูุฐุง ุงููุฌุงูุ
   - ูุง ูู ุงูุชุทูุฑุงุช ูุงูุงุจุชูุงุฑุงุช ุงูุฌุฏูุฏุฉุ
   - ูุง ูู ุงููุฑุต ุงููุงุดุฆุฉุ

ุงูุชุจ ุงููุชุงุฆุฌ ุจุชูุณูู JSON ูุงุถุญ ูููุธู:
{
  \"statistics\": [
    {\"number\": \"87%\", \"context\": \"ูุตู ุงูุฅุญุตุงุฆูุฉ\", \"source\": \"ุงููุตุฏุฑ\", \"impact\": 9}
  ],
  \"pain_points\": [\"ููุทุฉ ุฃูู 1\", \"ููุทุฉ ุฃูู 2\"],
  \"solutions\": [\"ุญู 1\", \"ุญู 2\"],
  \"success_examples\": [\"ูุซุงู ูุฌุงุญ 1\", \"ูุซุงู ูุฌุงุญ 2\"],
  \"power_words\": [\"ูููุฉ ูููุฉ 1\", \"ูููุฉ ูููุฉ 2\"],
  \"current_trends\": [\"ุงุชุฌุงู 1\", \"ุงุชุฌุงู 2\"]
}
";

            $response = OpenAI::chat()->create([
                'model' => 'gpt-4',
                'messages' => [
                    ['role' => 'system', 'content' => 'ุฃูุช ุฎุจูุฑ ุชุญููู ุงููุญุชูู ูุงูุงุชุฌุงูุงุช ูุน ูุนุฑูุฉ ุนูููุฉ ุจุงูุณูู ุงูุนุฑุจู ูุงูุนุงููู.'],
                    ['role' => 'user', 'content' => $analysisPrompt]
                ],
                'max_tokens' => 1500,
                'temperature' => 0.3,
            ]);

            $result = $response->choices[0]->message->content;
            
            // Try to parse JSON, fallback to structured text if needed
            $decoded = json_decode($result, true);
            if (json_last_error() === JSON_ERROR_NONE) {
                return $decoded;
            }
            
            // Fallback parsing if JSON fails
            return $this->parseInsightsFromText($result);
        });
    }

    /**
     * Stage 2: Generate optimized hooks
     */
    private function generateOptimizedHooks(array $insights, string $tone, string $topic): array
    {
        $hookPrompt = "
ุจูุงุกู ุนูู ุงูุชุญููู ุงูุชุงููุ ุฃูุดุฆ 8 ุฎุทุงูุงุช ูููุฉ ููุชููุนุฉ ููููุถูุน: {$topic}

ุงูุฅุญุตุงุฆูุงุช ุงููุชุงุญุฉ: " . json_encode($insights['statistics'] ?? []) . "
ููุงุท ุงูุฃูู: " . json_encode($insights['pain_points'] ?? []) . "
ุงูุญููู: " . json_encode($insights['solutions'] ?? []) . "
ุงููุจุฑุฉ: {$tone}

ูุชุทูุจุงุช ุงูุฎุทุงูุงุช:

1. ุฎุทุงูุงุช ุจุงูุฅุญุตุงุฆูุงุช (2 ุฎุทุงู):
   - ุงุณุชุฎุฏู ุงูุฅุญุตุงุฆูุงุช ุงููุชุงุญุฉ
   - ุงุฌุนููุง ุตุงุฏูุฉ ููุซูุฑุฉ ููุฏูุดุฉ
   - ูุซุงู: 'ูู ุชุนูู ุฃู 87% ูู ุงููุงุณ ููุดููู ูู X ุจุณุจุจ ุฎุทุฃ ูุงุญุฏุ'

2. ุฎุทุงูุงุช ุจุงูุฃุณุฆูุฉ (2 ุฎุทุงู):
   - ุฃุณุฆูุฉ ุชุซูุฑ ุงููุถูู ูุงูุชูููุฑ
   - ุชุณุชูุฏู ููุงุท ุงูุฃูู ูุจุงุดุฑุฉ
   - ูุซุงู: 'ููุงุฐุง ูุญูู ุงูุจุนุถ ูุฌุงุญุงู ุจุงูุฑุงู ุจูููุง ููุดู ุงูุขุฎุฑูู ูู ููุณ ุงููุฌุงูุ'

3. ุฎุทุงูุงุช ุจุงููุนูุฏ (2 ุฎุทุงู):
   - ูุนูุฏ ูููุฉ ููุงุจูุฉ ููุชุญููู
   - ูุฑุชุจุทุฉ ุจุงูุญููู ูุงูููุงุฆุฏ ุงููุชุงุญุฉ
   - ูุซุงู: 'ูู 60 ุซุงููุฉ ุณุชุชุนูู ุงูุทุฑููุฉ ุงูุชู ุบูุฑุช ุญูุงุฉ ุขูุงู ุงูุฃุดุฎุงุต'

4. ุฎุทุงูุงุช ุจุงููุดุงูู (2 ุฎุทุงู):
   - ุชุณูุท ุงูุถูุก ุนูู ูุดููุฉ ุดุงุฆุนุฉ ูููุญุฉ
   - ุชุฎูู ุฅูุญุงุญุงู ููุฑูุงู ููุญู
   - ูุซุงู: 'ุชููู ุนู ุงุฑุชูุงุจ ูุฐุง ุงูุฎุทุฃ ุงูุฐู ููููู ุขูุงู ุงูุฑูุงูุงุช ุดูุฑูุงู'

ุชุฎุตูุต ุงููุจุฑุฉ - {$tone}:
" . $this->getToneSpecificInstructions($tone) . "

ููู ุฎุทุงูุ ุงูุชุจ:
- ุงููุต (15-25 ูููุฉ ุนุฑุจูุฉ)
- ููุน ุงูุฎุทุงู
- ููุฉ ุงูุชุฃุซูุฑ ุงููุชููุนุฉ (1-10)
- ุณุจุจ ุงุฎุชูุงุฑ ูุฐุง ุงูุฎุทุงู

ุชูุณูู JSON:
{
  \"hooks\": [
    {
      \"text\": \"ุงููุต ุงูุนุฑุจู ููุง\",
      \"type\": \"statistic/question/promise/problem\",
      \"impact_score\": 8,
      \"reasoning\": \"ุณุจุจ ุงูููุฉ ูุงูุชุฃุซูุฑ\"
    }
  ]
}
";

        $response = OpenAI::chat()->create([
            'model' => 'gpt-4',
            'messages' => [
                ['role' => 'system', 'content' => 'ุฃูุช ุฎุจูุฑ ูู ูุชุงุจุฉ ุงูุฎุทุงูุงุช ุงููุคุซุฑุฉ ูุงูุฌุฐุงุจุฉ ูููุญุชูู ุงูุนุฑุจู.'],
                ['role' => 'user', 'content' => $hookPrompt]
            ],
            'max_tokens' => 1200,
            'temperature' => 0.7,
        ]);

        $result = $response->choices[0]->message->content;
        $decoded = json_decode($result, true);
        
        return $decoded['hooks'] ?? $this->generateFallbackHooks($topic, $tone);
    }

    /**
     * Stage 3: Generate relevant statistics
     */
    private function generateRelevantStatistics(string $topic): array
    {
        $statsPrompt = "
ุฃูุช ุฎุจูุฑ ูู ุงูุจุญุซ ูุงูุฅุญุตุงุฆูุงุช. ุงุฌูุน ุฃููู 5 ุฅุญุตุงุฆูุงุช ูุคุซุฑุฉ ููุชุนููุฉ ุจุงูููุถูุน: {$topic}

ุงููุทููุจ:
1. ุฅุญุตุงุฆูุงุช ุตุงุฏูุฉ ููุคุซุฑุฉ ูู ูุนุฑูุชู
2. ุชุฃูุฏ ูู ุฃู ุงูุฅุญุตุงุฆูุงุช ุญุฏูุซุฉ (2022-2024)
3. ุงุฐูุฑ ูุตุฏุฑ ุชูุฑูุจู ูููุซูู ููู ุฅุญุตุงุฆูุฉ
4. ุฑูุฒ ุนูู ุงูุฃุฑูุงู ุงูุชู ุชุซูุฑ ุงูุฏูุดุฉ ุฃู ุงูููู ุฃู ุงูุฅุนุฌุงุจ
5. ุงุฌุนู ุงูุฅุญุตุงุฆูุงุช ูุชููุนุฉ (ูููุ ูุดุงููุ ูุฑุตุ ุงุชุฌุงูุงุชุ ูุฌุงุญุงุช)

ููู ุฅุญุตุงุฆูุฉุ ูุฏู:
- ุงูุฑูู ุงูุฏููู ูุงููุณุจุฉ
- ุงูุณูุงู ูุงูุชูุณูุฑ ุงููุงุถุญ
- ุงููุตุฏุฑ ุงูุชูุฑูุจู ูุงูููุซูู
- ูุณุชูู ุงูุชุฃุซูุฑ ูุงูุฅุซุงุฑุฉ (1-10)
- ููููุฉ ุงุณุชุฎุฏุงููุง ูู ุงููุญุชูู

ุชูุณูู JSON:
{
  \"statistics\": [
    {
      \"number\": \"87%\",
      \"full_text\": \"87% ูู ุงููุณุชุซูุฑูู ุงูุนูุงุฑููู ููุดููู ูู ุงูุณูุฉ ุงูุฃููู\",
      \"context\": \"ูุตู ููุตู ููุฅุญุตุงุฆูุฉ ูุฃูููุชูุง\",
      \"source\": \"ุชูุฑูุฑ ุงูุงุณุชุซูุงุฑ ุงูุนูุงุฑู ุงูุณุนูุฏู 2024\",
      \"impact_level\": 9,
      \"usage_suggestion\": \"ููููุฉ ุงุณุชุฎุฏุงููุง ูู ุงูุฎุทุงู ุฃู ุงููุญุชูู\"
    }
  ]
}

ุงุจุญุซ ูู ูุนุฑูุชู ูุงุฌูุน ุฃููู ุงูุฅุญุตุงุฆูุงุช ุงููุชุนููุฉ ุจุงูููุถูุน:
";

        $response = OpenAI::chat()->create([
            'model' => 'gpt-4',
            'messages' => [
                ['role' => 'system', 'content' => 'ุฃูุช ุฎุจูุฑ ูู ุงูุจุญุซ ูุงูุฅุญุตุงุฆูุงุช ูุน ูุตูู ูุฃุญุฏุซ ุงูุจูุงูุงุช ูุงูุฏุฑุงุณุงุช.'],
                ['role' => 'user', 'content' => $statsPrompt]
            ],
            'max_tokens' => 1000,
            'temperature' => 0.2,
        ]);

        $result = $response->choices[0]->message->content;
        $decoded = json_decode($result, true);
        
        return $decoded['statistics'] ?? [];
    }

    /**
     * Stage 4: Assemble optimized script
     */
    private function assembleOptimizedScript(string $topic, ?string $keyPoints, array $insights, array $hooks, array $statistics, string $tone, int $duration): string
    {
        // Select best hook based on impact score
        $bestHook = $this->selectBestHook($hooks, $tone);
        $bestStatistic = $this->selectBestStatistic($statistics);
        
        $scriptPrompt = "
ุฃูุช ูุงุชุจ ุงุณูุฑุจุชุงุช ูุญุชุฑู ูุชุฎุตุต ูู ุงููุญุชูู ุงูุนุฑุจู ุนุงูู ุงูุฌูุฏุฉ. ุงูุชุจ ุงุณูุฑุจุช ููุฏูู ูุซุงูู ุจุงุณุชุฎุฏุงู ุงููุนูููุงุช ุงูุชุงููุฉ:

ุงูููุถูุน: {$topic}
ุงูููุงุท ุงูุฑุฆูุณูุฉ: " . ($keyPoints ?: 'ุบูุฑ ูุญุฏุฏ') . "
ุงููุฏุฉ ุงููุณุชูุฏูุฉ: {$duration} ุซุงููุฉ
ุงููุจุฑุฉ: {$tone}

ุงูุฎุทุงู ุงููุฎุชุงุฑ: {$bestHook['text']}
ุงูุฅุญุตุงุฆูุฉ ุงูุฃููู: {$bestStatistic['full_text']}

ุงููุนูููุงุช ุงููุชุงุญุฉ ููุงุณุชุฎุฏุงู:
- ููุงุท ุงูุฃูู: " . json_encode($insights['pain_points'] ?? []) . "
- ุงูุญููู: " . json_encode($insights['solutions'] ?? []) . "
- ุฃูุซูุฉ ุงููุฌุงุญ: " . json_encode($insights['success_examples'] ?? []) . "
- ุงููููุงุช ุงููููุฉ: " . json_encode($insights['power_words'] ?? []) . "

ูููู ุงูุงุณูุฑุจุช ุงููุทููุจ (ุชูุฒูุน ุฏููู ููููุช):

1. ุงูุฎุทุงู ุงูููู (8 ุซูุงูู - 20-24 ูููุฉ):
   - ุงุณุชุฎุฏู ุงูุฎุทุงู ุงููุฎุชุงุฑ ุฃู ุทูุฑ ูุณุฎุฉ ูุญุณูุฉ ููู
   - ุงุฌุนูู ุตุงุฏูุงู ููุซูุฑุงู ูููุถูู ูู ุฃูู 3 ุซูุงูู
   - ุฃุถู ุนูุตุฑ ุงูุฅูุญุงุญ ูุงูุฃูููุฉ
   - ุงุณุชุฎุฏู ุฑูู ุฃู ุฅุญุตุงุฆูุฉ ูุคุซุฑุฉ

2. ุชุญุฏูุฏ ุงููุดููุฉ (12 ุซุงููุฉ - 30-36 ูููุฉ):
   - ุงุณุชุฎุฏู ููุงุท ุงูุฃูู ุงููุญุฏุฏุฉ ูู ุงูุชุญููู
   - ุงุฌุนู ุงููุดุงูุฏ ูุดุนุฑ ุจุงููุดููุฉ ุดุฎุตูุงู
   - ุงุณุชุฎุฏู ูููุงุช ุนุงุทููุฉ ููุคุซุฑุฉ
   - ุงุฑุจุท ุงููุดููุฉ ุจุงููุงูุน ุงููููู

3. ุชูุฏูู ุงูุญู ูุงููุญุชูู ุงูุฑุฆูุณู (25 ุซุงููุฉ - 62-75 ูููุฉ):
   - ูุฏู ุงูุญู ุจุทุฑููุฉ ูุงุถุญุฉ ููุซูุฑุฉ
   - ุงุณุชุฎุฏู ูุซุงู ูู ุฃูุซูุฉ ุงููุฌุงุญ ุงููุชุงุญุฉ
   - ุฃุถู ุชูุงุตูู ุนูููุฉ ูุงุจูุฉ ููุชุทุจูู ููุฑุงู
   - ุงุฑุจุท ุงูุญู ุจุงูููุงุฆุฏ ุงููุญุฏุฏุฉ

4. ุงูุฏููู ูุงูุฅุซุจุงุช (10 ุซูุงูู - 25-30 ูููุฉ):
   - ุงุณุชุฎุฏู ุงูุฅุญุตุงุฆูุฉ ุงูุฃููู ูู ุงููุชุงุญุฉ
   - ุฃุถู ูุซุงู ูุฌุงุญ ูุญุฏุฏ ูููููุณ
   - ุงุฌุนู ุงูุฏููู ูุง ููุจู ุงูุดู ุฃู ุงูุฌุฏู
   - ุงุณุชุฎุฏู ุฃุฑูุงู ุฏูููุฉ ููุคุซุฑุฉ

5. ุฏุนูุฉ ูููุฉ ููุนูู (5 ุซูุงูู - 12-15 ูููุฉ):
   - ุฏุนูุฉ ูุญุฏุฏุฉ ููุงุถุญุฉ ููุชูุงุนู
   - ุฃุถู ุนูุตุฑ ุงูุฅูุญุงุญ ุฃู ุงูุญุตุฑูุฉ
   - ุงุฌุนููุง ุณููุฉ ุงูุชูููุฐ ููุจุงุดุฑุฉ
   - ุงุณุชุฎุฏู ูุนู ุฃูุฑ ููู ููุญูุฒ

ุชุฎุตูุต ุงููุจุฑุฉ - {$tone}:
" . $this->getToneSpecificInstructions($tone) . "

ูุชุทูุจุงุช ุฅุถุงููุฉ ูููุฉ:
- ุงุณุชุฎุฏู ุงููููุงุช ุงููููุฉ ุงููุญุฏุฏุฉ ูู ุงูุชุญููู
- ุฃุถู ุนูุงุตุฑ ุชูุงุนููุฉ (ุณุคุงู ูุจุงุดุฑ ููุฌูููุฑ)
- ุงุฌุนู ุงููุบุฉ ุจุตุฑูุฉ ุชุณุงุนุฏ ูู ุงูุชุตููุฑ ูุงูุฅุฎุฑุงุฌ
- ุชุฃูุฏ ูู ุงูุชุฏูู ุงูุทุจูุนู ูุงูููุทูู ุจูู ุงูุฃูุณุงู
- ุงุณุชุฎุฏู ุถููุฑ ุงููุฎุงุทุจ ูุฎูู ุชูุงุตู ูุจุงุดุฑ
- ุฃุถู ููุณุงุช ุนุงุทููุฉ ููุงุณุจุฉ ูููุจุฑุฉ

ุงูุชุจ ุงูุงุณูุฑุจุช ุงูุขู ุจุดูู ูุชุฏูู ูุทุจูุนู:
";

        $response = OpenAI::chat()->create([
            'model' => 'gpt-4',
            'messages' => [
                ['role' => 'system', 'content' => 'ุฃูุช ูุงุชุจ ุงุณูุฑุจุชุงุช ูุญุชุฑู ูุชุฎุตุต ูู ุงููุญุชูู ุงูุนุฑุจู ุนุงูู ุงูุฌูุฏุฉ ูุงูุชูุงุนู.'],
                ['role' => 'user', 'content' => $scriptPrompt]
            ],
            'max_tokens' => 1200,
            'temperature' => 0.8,
        ]);

        return $response->choices[0]->message->content;
    }

    /**
     * Stage 5: Analyze script quality
     */
    private function analyzeScriptQuality(string $script, string $tone, int $duration): array
    {
        $qualityPrompt = "
ูู ุจุชุญููู ุฌูุฏุฉ ุงูุงุณูุฑุจุช ุงูุชุงูู ููููู ูู 1-100 ุจูุงุกู ุนูู ูุนุงููุฑ ุงุญุชุฑุงููุฉ:

ุงูุงุณูุฑุจุช: {$script}
ุงููุจุฑุฉ ุงููุทููุจุฉ: {$tone}
ุงููุฏุฉ ุงููุณุชูุฏูุฉ: {$duration} ุซุงููุฉ

ูุนุงููุฑ ุงูุชูููู ุงูุดุงููุฉ:

1. ููุฉ ุงูุฎุทุงู ูุงูุฌุฐุจ (25 ููุทุฉ):
   - ูู ูุฌุฐุจ ุงูุงูุชุจุงู ูู ุฃูู 3 ุซูุงููุ
   - ูู ูุฎูู ูุถูู ููู ุฃู ุฅูุญุงุญ ููุฑูุ
   - ูู ูุญุชูู ุนูู ุนูุตุฑ ููุงุฌุฆ ุฃู ุตุงุฏูุ
   - ูู ูุณุชุฎุฏู ุฅุญุตุงุฆูุฉ ุฃู ุฑูู ูุคุซุฑุ

2. ูุถูุญ ุงููุญุชูู ูุงูุฑุณุงูุฉ (20 ููุทุฉ):
   - ูู ุงูุฑุณุงูุฉ ูุงุถุญุฉ ููููููุฉ ุชูุงูุงูุ
   - ูู ุงูุชุฏูู ููุทูู ููุชุฑุงุจุทุ
   - ูู ุงููุนูููุงุช ุฏูููุฉ ููููุฏุฉุ
   - ูู ูุญู ูุดููุฉ ุญููููุฉุ

3. ูุทุงุจูุฉ ุงููุจุฑุฉ ูุงูุฃุณููุจ (20 ููุทุฉ):
   - ูู ุงููุจุฑุฉ ูุชุณูุฉ ูุน ุงููุทููุจุ
   - ูู ุงููููุงุช ูุงูุชุนุจูุฑุงุช ููุงุณุจุฉุ
   - ูู ูุณุชูู ุงูุทุงูุฉ ููุงุณุจ ูููุจุฑุฉุ
   - ูู ุงูุฃุณููุจ ุฌุฐุงุจ ูููุงุณุจ ููุฌูููุฑุ

4. ุงูุชูุงุนู ูุงููุดุงุฑูุฉ (15 ููุทุฉ):
   - ูู ูุญุชูู ุนูู ุนูุงุตุฑ ุชูุงุนููุฉ ูููุฉุ
   - ูู ูุดุฌุน ุนูู ุงูุชุนููู ุฃู ุงููุดุงุฑูุฉุ
   - ูู ุงูุฏุนูุฉ ููุนูู ูุงุถุญุฉ ููููุฉุ
   - ูู ูุฎูู ุฑุบุจุฉ ูู ุงููุชุงุจุนุฉุ

5. ุงูุชูููุช ูุงูุทูู ุงูููุงุณุจ (10 ููุทุฉ):
   - ูู ุงูุทูู ููุงุณุจ ูููุฏุฉ ุงููุณุชูุฏูุฉุ
   - ูู ุงูุชูุฒูุน ูุชูุงุฒู ุจูู ุงูุฃูุณุงูุ
   - ูู ุงูุฅููุงุน ููุงุณุจ ูููุญุชููุ

6. ุงูุฃุตุงูุฉ ูุงูุฅุจุฏุงุน (10 ููุทุฉ):
   - ูู ุงููุญุชูู ูุจุชูุฑ ููููุฒุ
   - ูู ูุชููุฒ ุนู ุงููุญุชูู ุงูุดุงุฆุนุ
   - ูู ููุฏู ูููุฉ ูุฑูุฏุฉุ

ูุฏู ุงูุชูููู ุจุชูุณูู JSON ููุตู:
{
  \"overall_score\": 85,
  \"breakdown\": {
    \"hook_strength\": 22,
    \"content_clarity\": 18,
    \"tone_matching\": 19,
    \"engagement\": 13,
    \"timing\": 8,
    \"originality\": 9
  },
  \"strengths\": [\"ูุงุฆูุฉ ููุงุท ุงูููุฉ\"],
  \"improvements\": [\"ูุงุฆูุฉ ููุงุท ุงูุชุญุณูู ุงูููุชุฑุญุฉ\"],
  \"confidence_score\": 0.92,
  \"engagement_prediction\": \"high/medium/low\",
  \"target_audience_fit\": \"excellent/good/fair/poor\"
}
";

        $response = OpenAI::chat()->create([
            'model' => 'gpt-4',
            'messages' => [
                ['role' => 'system', 'content' => 'ุฃูุช ุฎุจูุฑ ุชูููู ุงููุญุชูู ูุงูุงุณูุฑุจุชุงุช ูุน ุฎุจุฑุฉ ูู ุชุญููู ุงูุฃุฏุงุก ูุงูุชูุงุนู.'],
                ['role' => 'user', 'content' => $qualityPrompt]
            ],
            'max_tokens' => 800,
            'temperature' => 0.1,
        ]);

        $result = $response->choices[0]->message->content;
        $decoded = json_decode($result, true);
        
        return $decoded ?? [
            'overall_score' => 75,
            'confidence_score' => 0.8,
            'engagement_prediction' => 'medium'
        ];
    }

    // Helper methods
    private function selectBestHook(array $hooks, string $tone): array
    {
        if (empty($hooks)) {
            return ['text' => 'ูู ุชุฑูุฏ ูุนุฑูุฉ ุงูุณุฑุ', 'impact_score' => 7];
        }

        // Sort by impact score and select the best one
        usort($hooks, function($a, $b) {
            return ($b['impact_score'] ?? 0) <=> ($a['impact_score'] ?? 0);
        });

        return $hooks[0];
    }

    private function selectBestStatistic(array $statistics): array
    {
        if (empty($statistics)) {
            return ['full_text' => 'ุงูุฏุฑุงุณุงุช ุชุคูุฏ ูุนุงููุฉ ูุฐู ุงูุทุฑููุฉ'];
        }

        // Sort by impact level and select the best one
        usort($statistics, function($a, $b) {
            return ($b['impact_level'] ?? 0) <=> ($a['impact_level'] ?? 0);
        });

        return $statistics[0];
    }

    private function getToneSpecificInstructions(string $tone): string
    {
        return match($tone) {
            'enthusiastic' => "
- ุงุณุชุฎุฏู ูููุงุช ุงูุทุงูุฉ: 'ูุฐููุ ุฑุงุฆุนุ ูุง ููุตุฏูุ ุซูุฑูุ ุฎุงุฑู'
- ุฃุถู ุฑููุฒ ุชุนุจูุฑูุฉ ููุงุณุจุฉ: ๐ฅโก๐ฅ๐
- ุงุฌุนู ุงูุฌูู ูุตูุฑุฉ ููุชูุฌุฑุฉ
- ุงุณุชุฎุฏู ุงูุชุนุฌุจ ุจูุซุฑุฉ
- ุฃุถู ุนูุตุฑ ุงูุฅุซุงุฑุฉ ูุงูุชุดููู
- ุงุฌุนู ูู ุฌููุฉ ุชุจูู ุนูู ุงูุทุงูุฉ ุงูุณุงุจูุฉ",
            
            'comedy' => "
- ุงุณุชุฎุฏู ููุงุฑูุงุช ูุถุญูุฉ ููุฃูููุฉ
- ุฃุถู ููุงูู ุทุฑููุฉ ููุฑ ุจูุง ุงูุฌููุน
- ุงุณุชุฎุฏู ุงูุณุฎุฑูุฉ ุงููุทููุฉ ูู ุงููุดุงูู ุงูุดุงุฆุนุฉ
- ุงุฌุนู ุงูููุฌุฉ ุฎูููุฉ ููุฑุญุฉ
- ุฃุถู ุชุดุจููุงุช ูุถุญูุฉ ููุจุชูุฑุฉ
- ุงุณุชุฎุฏู ุงูููููุฏูุง ูุชุจุณูุท ุงูููุงููู ุงููุนูุฏุฉ",
            
            'educational' => "
- ุงุณุชุฎุฏู ูููู ููุทูู: 'ุฃููุงูุ ุซุงููุงูุ ูุฃุฎูุฑุงู'
- ุฃุถู ุฃูุซูุฉ ูุงุถุญุฉ ููููููุฉ
- ุงุฌุนู ุงูุชุนุฑููุงุช ุจุณูุทุฉ ููุจุงุดุฑุฉ
- ุงุณุชุฎุฏู ุฃุณููุจ ุงูุฃุณุชุงุฐ ุงููุฏูุฏ
- ุฃุถู ูุตุงุฆุญ ุนูููุฉ ูุงุจูุฉ ููุชุทุจูู
- ุงุฌุนู ูู ููุทุฉ ุชุจูู ุนูู ุงูุณุงุจูุฉ ููุทููุงู",
            
            'storytelling' => "
- ุงุจุฏุฃ ุจู 'ุฏุนูู ุฃุญูู ูู ูุตุฉ...'
- ุฃุถู ุดุฎุตูุงุช ูุงุถุญุฉ ููุญุฏุฏุฉ
- ุงุฎูู ุตุฑุงุน ุฃู ุชุญุฏู ูุซูุฑ
- ุงุณุชุฎุฏู ุชูุงุตูู ุญุณูุฉ ูุนุงุทููุฉ
- ุงุฌุนู ุงููุตุฉ ุชุชุทูุฑ ุจุดูู ุทุจูุนู
- ุงุฎุชุชู ุจุฏุฑุณ ูุณุชูุงุฏ ููู ููุคุซุฑ",
            
            'professional' => "
- ุงุณุชุฎุฏู ูุตุทูุญุงุช ุชูููุฉ ุฏูููุฉ
- ุฃุถู ุฃุฑูุงู ูุฅุญุตุงุฆูุงุช ูุญุฏุฏุฉ
- ุงุฌุนู ุงูุฃุณููุจ ููุถูุนู ููุจุงุดุฑ
- ุงุณุชุฎุฏู ูุฑุงุฌุน ูุฃุฏูุฉ ุนูููุฉ
- ุฃุถู ุชุญููู ุนููู ููุฏุฑูุณ
- ุงุฌุนู ูู ุงุฏุนุงุก ูุฏุนูู ุจุฏููู ููู",
            
            default => "ุงุณุชุฎุฏู ุฃุณููุจ ูุงุถุญ ููุจุงุดุฑ ูุน ูุบุฉ ุจุณูุทุฉ ููููููุฉ"
        };
    }

    private function calculateDuration(string $script, string $tone): int
    {
        $wordCount = str_word_count($script);
        
        // Tone-specific speaking rates (words per second)
        $rates = [
            'enthusiastic' => 3.0,  // Faster pace
            'comedy' => 2.8,        // Varied pace
            'educational' => 2.7,   // Standard pace
            'storytelling' => 2.3,  // Slower for drama
            'professional' => 2.5,  // Measured pace
        ];
        
        $rate = $rates[$tone] ?? 2.7;
        return (int) ceil($wordCount / $rate);
    }

    private function getProcessingTime(): float
    {
        return round(microtime(true) - $this->processingStartTime, 2);
    }

    private function parseInsightsFromText(string $text): array
    {
        // Fallback parsing if JSON fails
        return [
            'statistics' => [['number' => '85%', 'context' => 'ุฅุญุตุงุฆูุฉ ุนุงูุฉ', 'source' => 'ุฏุฑุงุณุงุช ูุชููุนุฉ', 'impact' => 7]],
            'pain_points' => ['ุตุนูุจุฉ ูู ุงูุชุทุจูู', 'ููุต ุงููุนุฑูุฉ'],
            'solutions' => ['ุงูุชุนูู ุงููุณุชูุฑ', 'ุงูููุงุฑุณุฉ ุงูุนูููุฉ'],
            'success_examples' => ['ูุตุต ูุฌุงุญ ููููุฉ'],
            'power_words' => ['ูุฐูู', 'ุฑุงุฆุน', 'ูุนุงู'],
            'current_trends' => ['ุงุชุฌุงูุงุช ุญุฏูุซุฉ ูู ุงููุฌุงู']
        ];
    }

    private function generateFallbackHooks(string $topic, string $tone): array
    {
        return [
            [
                'text' => "ูู ุชุฑูุฏ ูุนุฑูุฉ ุงูุณุฑ ูุฑุงุก {$topic}ุ",
                'type' => 'question',
                'impact_score' => 7,
                'reasoning' => 'ุณุคุงู ูุซูุฑ ุงููุถูู'
            ]
        ];
    }

    private function getEnhancedMockResponse(string $topic, ?string $keyPoints, string $tone, int $duration): array
    {
        $mockScript = $this->generateEnhancedMockScript($topic, $keyPoints, $tone, $duration);
        
        return [
            'success' => true,
            'script' => $mockScript,
            'word_count' => str_word_count($mockScript),
            'estimated_duration' => $duration,
            'quality_analysis' => [
                'overall_score' => 85,
                'confidence_score' => 0.9,
                'engagement_prediction' => 'high'
            ],
            'insights_used' => [
                'statistics' => [['number' => '87%', 'context' => 'ูุณุจุฉ ุงููุฌุงุญ']],
                'pain_points' => ['ุงูุชุญุฏู ุงูุฑุฆูุณู'],
                'solutions' => ['ุงูุญู ุงููุจุชูุฑ']
            ],
            'hooks_generated' => [
                ['text' => 'ุฎุทุงู ููู ููุคุซุฑ', 'impact_score' => 9]
            ],
            'generation_metadata' => [
                'stages_completed' => 5,
                'processing_time' => 1.5,
                'confidence_score' => 0.9,
                'enhancement_level' => 'intelligent_mock'
            ]
        ];
    }

    private function generateEnhancedMockScript(string $topic, ?string $keyPoints, string $tone, int $duration): string
    {
        $tonePrefix = match($tone) {
            'enthusiastic' => '๐ฅ ูู ุชุฑูุฏ ุฃู ุชูุชุดู ุงูุณุฑ ุงููุฐูู ูุฑุงุก',
            'comedy' => '๐ ุชุฎูู ูู ููุช ูู ุฃู ููุงู ุทุฑููุฉ ูุถุญูุฉ ูููู',
            'educational' => '๐ ุฏุนูู ุฃุนููู ุฃูู ูุง ุชุญุชุงุฌ ูุนุฑูุชู ุนู',
            'storytelling' => 'โจ ุฏุนูู ุฃุญูู ูู ูุตุฉ ูุฐููุฉ ุนู',
            'professional' => '๐ผ ุงูุฏุฑุงุณุงุช ุงูุญุฏูุซุฉ ุชุคูุฏ ุฃูููุฉ ููู',
            default => 'ูู ุชุฑูุฏ ูุนุฑูุฉ ุงููุฒูุฏ ุนู'
        };

        return "{$tonePrefix} {$topic}ุ

ูู ุงููุงูุนุ 87% ูู ุงููุงุณ ูุง ูุนุฑููู ูุฐู ุงููุนูููุฉ ุงููููุฉ ุงูุชู ุณุชุบูุฑ ูุธุฑุชูู ุชูุงูุงู.

ุงููุดููุฉ ุงูุญููููุฉ ุฃู ูุนุธููุง ููุงุฌู ุชุญุฏูุงุช ูู ููู ูุฐุง ุงูููุถูุน ุจุงูุทุฑููุฉ ุงูุตุญูุญุฉุ ููุง ูุคุฏู ุฅูู ูุชุงุฆุฌ ุบูุฑ ูุฑุถูุฉ.

ููู ุงูุญู ุฃุจุณุท ููุง ุชุชุฎูู! " . ($keyPoints ? "ุฎุงุตุฉ ุนูุฏูุง ูุฑูุฒ ุนูู: {$keyPoints}. " : "") . "ุงูุฎุจุฑุงุก ููุตุญูู ุจุชุทุจูู ูุฐู ุงูุงุณุชุฑุงุชูุฌูุฉ ุงููุฌุฑุจุฉ ุงูุชู ุญููุช ูุฌุงุญุงู ุจุงูุฑุงู ูุน ุขูุงู ุงูุฃุดุฎุงุต.

ุงูุฏูููุ ุงูุฃุฑูุงู ุชุชุญุฏุซ ุนู ููุณูุง - ูุณุจุฉ ูุฌุงุญ ุชุตู ุฅูู 95% ููู ุทุจู ูุฐู ุงูุทุฑููุฉ ุจุงูุดูู ุงูุตุญูุญ.

ุฅุฐุง ุฃุนุฌุจู ุงููุญุชููุ ุดุงุฑูู ูุน ุฃุตุฏูุงุฆู ูุงุชุจุนูุง ูููุฒูุฏ ูู ุงููุตุงุฆุญ ุงููููุฏุฉ!";
    }
}

